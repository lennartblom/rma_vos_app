/*
 * File: app/controller/Wecker.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('VosNavigator.controller.Wecker', {
    extend: 'Ext.app.Controller',

    config: {
        weckerIsOn: false,
        sliderValue: 200,
        shortestPath: true,
        weckerKlingeltMehrfach: false,
        tune: 'superMario.mp3',
        aktuellePosition: {
            lat: 0.0,
            lng: 0.0
        },
        weckerKlingelt: false,
        trackingId: null,
        taskEngine: {
            taskGetPos: null,
            taskCheckDistance: null
        },
        task: null,

        refs: {
            weckerBackButton: 'button#weckerBackButton',
            MainView: 'container#MainView',
            weckerView: 'container#mycontainer1',
            weckRadius: 'sliderfield#weckRadius',
            sliderValueLabel: 'label#sliderValueLabel',
            weckerOnOffSwitch: 'togglefield#weckerOnOffSwitch',
            selectTune: 'selectfield#selectTune',
            shortestPath: 'checkboxfield#shortestPath',
            mehrfachKlingelnOnOffSwitch: 'togglefield#mehrfachKlingelnOnOffSwitch'
        },

        control: {
            "button#weckerBackButton": {
                tap: 'weckerBackButtonTap'
            },
            "sliderfield#weckRadius": {
                change: 'onWeckRadiusChange',
                drag: 'onWeckRadiusDrag'
            },
            "togglefield#weckerOnOffSwitch": {
                change: 'onWeckerOnOffChange'
            },
            "selectfield#selectTune": {
                change: 'onTuneChange'
            }
        }
    },

    weckerBackButtonTap: function(button, e, eOpts) {
        this.getWeckerView().hide();
        this.getMainView().show();
    },

    onWeckRadiusChange: function(me, sl, thumb, newValue, oldValue, eOpts) {
        Ext.getCmp('sliderValueLabel').setHtml(newValue+" vor dem Zielpunkt");
        this.setSliderValue(newValue);
    },

    onWeckRadiusDrag: function(sliderfield, sl, thumb, e, eOpts) {
        var slider = this.getWeckRadius();
        var label = this.getSliderValueLabel();
        label.setHtml(slider.getValue()+"m vor dem Zielpunkt");
        this.setSliderValue(slider.getValue());
    },

    onWeckerOnOffChange: function(togglefield, newValue, oldValue, eOpts) {
        this.setWeckerIsOn(newValue);
        console.log("Toggle Field value: "+newValue);
        this.initiateTracking(newValue);
        //this.getApplication().getController('Wecker').wecken();
    },

    onTuneChange: function(selectfield, newValue, oldValue, eOpts) {
        this.setTune("resources/tones/"+newValue);
    },

    wecken: function() {
        navigator.vibrate(1);
        if(!this.getWeckerKlingelt()){
            navigator.notification.alert("Sie haben den Ziel Ort erreicht, oder befinden sich in unmitelbarer NÃ¤he",function(){myMedia.stop();},"Zielort Erreicht!");
            var weckTune = new Media(this.getTune());
            weckTune.play();
            navigator.vibrate(1);
        }
        navigator.vibrate(1);
    },

    initiateTracking: function(isTracking) {
        console.log("initiateTracking wurde aufgerufen");
        var pace = this.getApplication().getController('Settings').getSliderPace()*1000;
        if(isTracking){
            this.initiateTaskManager(pace);
            console.log("device is tracking");
            //this.setupBackgroundPace();
            //this.checkDistance();
        }else{
            this.stopTaskManager();
            //this.bgGeo.stop();
               console.log("pace disabled");

        }
    },

    resetGeoTimer: function(interval) {
        if(this.getWeckerIsOn()){
            var taskEngine = this.getTaskEngine();
            clearInterval(taskEngine.taskGetPos);
            taskEngine.taskGetPos = setInterval(Ext.bind(this.activateTracker,this),interval);
            console.log("resetGeoTimer wurde aufgerufen");
        }
    },

    entfernung: function() {
        console.log("distance Berechnung");
        var latCurrent =this.lat;
        var lngCurrent =this.lng;
        var latDestination =this.lat;
        var lngDestination =this.lng;
        var distance = 0.0;
        var deltaX = 71.5 * (lngCurrent-lngDestination);
        var deltaY = 111.3 * (latCurrent-latDestination);
        var radius = 200;
        if(deltaX!==0||deltaY!==0){
        distance = Math.sqrt(deltaX*deltaX+deltaY*deltaY)*1000;
        }
        console.log(distance);
        console.log(radius);
        if(distance<=radius){
            console.log("distance<radius");
            this.getApplication().getController('Wecker').wecken();
        }

    },

    checkDistance: function() {
        //this.entfernung();

    },

    activateTracker: function() {

        console.log("activateTracker wurde aufgerufen");
             this.trackingId = new Ext.device.Geolocation.getCurrentPosition({
                 allowHighAccuracy:true,
                 success: Ext.bind(function(position){
                                                     var pos = this.getAktuellePosition();
                                                     pos.lat=position.coords.latitude;
                                                     pos.lng=position.coords.longitude;
                                   },this),
                 failure: function(){
                     console.log("Fehler beim Tracken");
                 }
             });
        console.log("Aktuelle Pos wurde erfasst");
        console.log("Aktuelle Position: "+this.getAktuellePosition().lat+" "+this.getAktuellePosition().lng);
    },

    saveGeoLocation: function(position) {
        console.log("saveGeo wurde aufgerufen");
        var pos = {lat:position.coords.latitude,
                   lng:position.coords.longitude};
        this.setAktuellePosition(pos);
        console.log("Aktuelle Position: "+this.getAktuellePosition().lat+
                    " "+this.getAktuellePosition().lng);
    },

    initiateTaskManager: function(pace) {
        var taskEngine = this.getTaskEngine();
        taskEngine.taskGetPos = setInterval(Ext.bind(this.activateTracker,this),pace);
        taskEngine.taskCheckDistance = setInterval(Ext.bind(this.checkDistance,this),5000);
        console.log("taskmanager wurde initialisiert");
    },

    stopTaskManager: function() {
        var taskEngine = this.getTaskEngine();
        clearInterval(taskEngine.taskGetPos);
        clearInterval(taskEngine.taskCheckDistance);
    }

});